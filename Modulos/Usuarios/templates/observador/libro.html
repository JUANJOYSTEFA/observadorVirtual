{% load static %}
<!DOCTYPE html>
<html lang="es">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Observador de {{estudiante.nombre}} {{estudiante.apellido}}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="{% static 'img/favicon.ico'%}" rel="icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  </head>

  <body>
    <link rel="stylesheet" href="{% static 'css/stylelibro.css' %}">
    <div class="container">
      <div class="back-button-container">
        <a href="{% url 'home' %}">
          <button class="btn btn-secondary back-button">
            <i class="bi bi-arrow-left"></i> Volver al inicio
          </button>
        </a>
      </div>
      <div class="book-container">
        <div class="book" id="book">
          <!-- Portada -->
          <div class="page cover current" id="cover">
            <div class="page-content">
              <h1 class="mb-4">Observador Virtual</h1>
              {% if estudiante.imagen_perfil %}
              <img src="{{ estudiante.imagen_perfil.url }}" alt="Foto de perfil de {{ estudiante.nombre }}"
                class="img-perfil" height="250px" style="border-radius: 10%;">
              {% else %}
              <img src="{% static 'img/default-profile.png' %}" alt="Imagen por defecto" class="img-perfil"
                height="250px">
              {% endif %}
              <div class="student-info mt-3">
                <h2>{{estudiante.nombre}} {{estudiante.apellido}}</h2>
                <p class="lead">Grado: {{estudiante.idGrado.grado}}</p>
              </div>
            </div>
          </div>

          <!-- Página 1 -->
          <div class="page" id="page1">
            <div class="page-content">
              <h2>Información Personal</h2>
              <div class="row mt-4">
                <div class="col-md-6">
                  <div class="mb-3">
                    <strong>Nombre Completo:</strong>
                    <p>{{estudiante.nombre}} {{estudiante.apellido}}</p>
                  </div>
                  <div class="mb-3">
                    <strong>Fecha de Nacimiento:</strong>
                    <p>{{estudiante.fechaNacimiento}}</p>
                  </div>
                  <div class="mb-3">
                    <strong>Correo Electrónico:</strong>
                    <p>{{estudiante.correo}}</p>
                  </div>
                </div>
                {% if acudiente %}
                <div class="col-md-6">
                  <div class="mb-3">
                    <strong>Nombre del Acudiente:</strong>
                    <p>{{acudiente.nombre}} {{acudiente.apellido}}</p>
                  </div>
                  <div class="mb-3">
                    <strong>Teléfono del Acudiente:</strong>
                    <p>{{acudiente.telefono}}</p>
                  </div>
                  <div class="mb-3">
                    <strong>Correo Electrónico del Acudiente:</strong>
                    <p>{{acudiente.correo}}</p>
                  </div>
                </div>
                {% else %}
                <div class="col-md-6">
                  <div class="mb-3">
                    <strong>Nombre del Acudiente:</strong>
                    <p>Aún No Registrado</p>
                  </div>
                  <div class="mb-3">
                    <strong>Teléfono del Acudiente:</strong>
                    <p>Aún No Registrado</p>
                  </div>
                  <div class="mb-3">
                    <strong>Correo Electrónico del Acudiente:</strong>
                    <p>Aún No Registrado</p>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
            <div class="page-number">1</div>
          </div>

          <!-- Página de observaciones -->
          {% for grupo in observaciones_agrupadas %}
          <div class="page">
            <div class="page-content">
              <h2>Observaciones</h2>
              <div class="table-responsive mt-4">
                <table class="table table-striped">
                  {% for obs in grupo %}
                  <tr>
                    <td>Fecha: {{obs.fecha}} {{obs.hora}}</td>
                    <td>{{obs.idFalta}}</td>
                  </tr>
                  <tr>
                    <td colspan="2">Descripción: {{obs.comentario}}</td>
                  </tr>
                  {% endfor %}
                </table>
              </div>
            </div>
            <div class="page-number">{{ forloop.counter|add:"1" }}</div>
          </div>
          {% empty %}
          <div class="page">
            <div class="page-content">
              <div class="alert alert-success" role="alert">
                ¡Felicitaciones no tienes observaciones! ¡Sigue así!
              </div>
            </div>
            <div class="page-number">2</div>
          </div>
          {% endfor %}



          <!-- Controles del libro -->
          <div class="controls">
            <button class="btn btn-primary" id="prev-btn" disabled>
              <i class="bi bi-arrow-left"></i>
            </button>
            <button class="btn btn-primary" id="next-btn">
              <i class="bi bi-arrow-right"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="fab-container">
        <div class="fab-item">
          <a href="{% url 'generarPdfObservaciones' idEstudiante %}">
            <button class="fab-button">
              <i class="bi bi-file-earmark-pdf"></i>
              <span class="fab-tooltip">Descargar PDF</span>
            </button>
          </a>
        </div>
        {% if admin %}
        <div class="fab-item">
          <button class="fab-button" data-bs-toggle="modal" data-bs-target="#modalCitacion">
            <i class="bi bi-calendar-event"></i>
            <span class="fab-tooltip">Crear Citación</span>
          </button>
        </div>
        <div class="fab-item">
          <a href="{% url 'agregarObservacionProfesor' idEstudiante %}">
            <button class="fab-button">
              <i class="bi bi-file-earmark-plus"></i>
              <span class="fab-tooltip">Agregar Observación</span>
            </button>
          </a>
        </div>
        {% endif %}
      </div>
      <!-- Modal de las citaciones -->
      <div class="modal fade" id="modalCitacion" tabindex="-1" aria-labelledby="modalCitacionLabel" aria-hidden="true">
        <div class="modal-dialog">
          <form method="post" action="{% url 'crearCitacion' estudiante.idEstudiante   %}">
            {% csrf_token %}
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="modalCitacionLabel">Agendar Citación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label for="fecha" class="form-label">Fecha</label>
                  <input type="date" class="form-control" name="fecha" required>
                </div>
                <div class="mb-3">
                  <label for="hora" class="form-label">Hora</label>
                  <input type="time" class="form-control" name="hora" required>
                </div>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-success">Guardar y Agendar</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const book = document.getElementById('book');
        const pages = document.querySelectorAll('.page');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        let currentPage = 0;
        const totalPages = pages.length;

        // Función para actualizar los botones
        function updateButtons() {
          prevBtn.disabled = currentPage === 0;
          nextBtn.disabled = currentPage === totalPages - 1;
        }

        // Función para pasar a la siguiente página
        function nextPage() {
          if (currentPage < totalPages - 1) {
            // Obtener la página actual y la siguiente
            const currentPageElem = pages[currentPage];
            const nextPageElem = pages[currentPage + 1];

            // Aplicar las clases para la animación
            currentPageElem.classList.add('flipped');
            currentPageElem.classList.remove('current');
            nextPageElem.classList.add('current');

            // Actualizar el índice de la página actual
            currentPage++;

            // Actualizar los botones
            updateButtons();
          }
        }

        // Función para ir a la página anterior
        function prevPage() {
          if (currentPage > 0) {
            // Obtener la página actual y la anterior
            const currentPageElem = pages[currentPage];
            const prevPageElem = pages[currentPage - 1];

            // Aplicar las clases para la animación
            currentPageElem.classList.remove('current');
            prevPageElem.classList.remove('flipped');
            prevPageElem.classList.add('current');

            // Actualizar el índice de la página actual
            currentPage--;

            // Actualizar los botones
            updateButtons();
          }
        }

        // Asignar los eventos a los botones
        nextBtn.addEventListener('click', nextPage);
        prevBtn.addEventListener('click', prevPage);

        // Inicializar los botones
        updateButtons();

        // Ajustar z-index de las páginas para la visualización correcta
        function updateZIndex() {
          pages.forEach((page, index) => {
            if (index < currentPage) {
              page.style.zIndex = 1;
            } else if (index === currentPage) {
              page.style.zIndex = totalPages;
            } else {
              page.style.zIndex = totalPages - index;
            }
          });
        }

        // Ajustar z-index inicial
        updateZIndex();

        // Actualizar z-index cuando cambia la página
        nextBtn.addEventListener('click', updateZIndex);
        prevBtn.addEventListener('click', updateZIndex);

        // Añadir funcionalidad para pasar las páginas con las teclas de flecha
        document.addEventListener('keydown', function (event) {
          if (event.key === 'ArrowRight') {
            nextPage();  // Flecha derecha: siguiente página
          } else if (event.key === 'ArrowLeft') {
            prevPage();  // Flecha izquierda: página anterior
          }
        });
      });
    </script>

  </body>

</html>
